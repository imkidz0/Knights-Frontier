# CVE-2012-3748 상세 분석

## 개요

CVE-2012-3748은 Apple iOS 6.0.1 이전 버전과 Safari 6.0.2 이전 버전의 WebKit에 존재하는 Race Condition 취약점으로, 원격 공격자가 임의 코드를 실행하거나 서비스 거부를 유발할 수 있습니다.

## 기본 정보

- **CVE ID**: CVE-2012-3748
- **취약점 유형**: Race Condition (CWE-362)
- **발견자**: Vitaliy Toropov
- **패치 날짜**: 2012년 11월 1일
- **영향 받는 버전**: Apple Safari 6.0.1 for iOS 6.0 및 OS X 10.7/8, 이전 버전 포함 가능

## 취약점 상세

### 핵심 원인

힙 메모리 버퍼 오버플로우 취약점이 WebKit의 JavaScriptCore JSArray::sort() 메서드에 존재합니다. 이 메서드는 사용자 정의 JavaScript 함수를 받아들이고, 배열 항목을 비교하기 위해 네이티브 코드에서 이를 호출합니다. 만약 이 비교 함수가 배열 길이를 줄이면, 후행 배열 항목들이 "m_storage->m_vector[]" 버퍼 외부에 작성되어 힙 메모리 손상이 발생합니다.

### 취약점 메커니즘

정렬을 위해 반복할 메모리 청크는 정렬 시작 시 고정됩니다. 그러나 splice 작업이 정렬 중간에, JavaScript 정렬 콜백에서 호출됩니다. 배열을 Shift하면 본질적으로 첫 번째 요소가 제거되고, 내부적으로는 m_storage 포인터를 한 요소(8바이트)만큼 이동시키고 크기를 1 감소시킵니다. 코드는 여전히 배열 길이가 2라고 믿고 있으므로 두 번 반복하고 두 개의 정렬된 값을 작성합니다. 그러나 쓰기는 한 요소만큼 이동된 m_storage 포인터에서 시작됩니다. 이것이 범위 외 쓰기, 즉 버퍼 오버플로우입니다.

### 공격 시나리오

1. 공격자가 악의적인 JavaScript 코드가 포함된 웹 페이지를 제작
2. 피해자가 해당 페이지를 브라우징하도록 유도
3. JSArray::sort() 메서드에 사용자 정의 비교 함수 전달
4. 비교 함수 내에서 배열 길이를 조작 (예: Array.shift() 사용)
5. 힙 버퍼 오버플로우 발생
6. 내부 JS 객체 메모리 손상
7. 임의 코드 실행 (ARM/x64 페이로드 실행 가능)

## 익스플로잇 기법

### 배열 조작 방식

Array.shift()를 사용한 익스플로잇 경로가 유일한 명백한 방법입니다. Array.pop()과 같은 더 일반적인 방법으로 배열을 작게 만들 수 있는지 궁금할 수 있지만, 코드가 백킹 스토어를 더 작은 크기로 재할당하는 것을 매우 꺼려하기 때문입니다.

### 메모리 손상 과정

정렬 작업 중:
1. 배열이 길이 2의 Vector 버퍼로 할당됨
2. 정렬 콜백에서 배열에 대량의 요소 추가 (sparse map으로 이동)
3. sparse map의 256개 요소가 2개 크기의 Vector 버퍼에 추가됨
4. Vector 버퍼는 기본 최소 용량 16으로 인한 여유 공간이 있지만, 256개 요소는 여유 공간을 채우고 인접 할당을 파괴하기에 충분합니다

## PS4에서의 활용

### 펌웨어 1.76 익스플로잇

첫 번째 문서에서 언급된 것처럼:
- PS4 펌웨어 1.76의 브라우저는 CVE-2012-3748에 취약한 WebKit 버전 사용
- 2014년 nas와 Proxima가 Mac OS X Safari용으로 작성된 익스플로잇을 PS4 인터넷 브라우저로 포팅 성공
- PoC 코드를 공개하여 PS4 해킹의 첫 진입점으로 활용
- 임의 읽기/쓰기 접근 제공
- 스택의 반환 주소를 덮어써서 명령 포인터 레지스터(rip) 제어
- ROP 실행 가능

## 패치 내역

Apple은 다음 업데이트에서 이 취약점을 패치했습니다:
- iOS 6.0.1 (2012년 11월)
- Safari 6.0.2 (2012년 11월)
- Apple TV 5.1.1

## 보안 영향

- **CVSS v2 점수**: 5.1 (Medium)
- **공격 벡터**: 네트워크 (원격)
- **공격 복잡도**: 높음
- **인증 필요**: 없음
- **기밀성/무결성/가용성 영향**: 부분적

## 참고 자료

- [Exploit-DB PoC (28081)](https://www.exploit-db.com/exploits/28081/)
- [Apple Security Advisory APPLE-SA-2012-11-01-2](http://lists.apple.com/archives/security-announce/2012/Nov/msg00001.html)
- [PS4 Playground GitHub](https://github.com/CTurt/PS4-playground)

## 관련 취약점

이후 WebKit에서 유사한 JSArray 관련 취약점들이 계속 발견되었습니다:
- CVE-2017-2536: Array spreading 정수 오버플로우
- CVE-2017-6984: Intl.getCanonicalLocales 힙 버퍼 오버플로우
- 기타 다수의 JSArray 관련 메모리 손상 취약점들
